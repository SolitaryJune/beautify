name: Pages CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write  # éœ€è¦å†™æƒé™ä»¥æ”¯æŒ Git åŽ†å²æ“ä½œ
  pages: write
  id-token: write
  actions: write  # éœ€è¦å†™æƒé™ä»¥åˆ é™¤ workflow runs

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!(github.event_name == 'push' && contains(github.event.head_commit.message, '[skip ci]'))"
    steps:
      - name: Check out project
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - uses: actions/cache@v4  # Updated to v4
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn

      - name: Run code quality tools
        run: yarn lint

      - name: Build development website
        if: ${{ github.event_name == 'pull_request' }}
        run: yarn build --environment development

      - name: Build production website
        if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
        run: yarn build

      - name: Setup Pages
        if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
        id: pages
        uses: actions/configure-pages@v5  # Updated to v5

      - name: Upload artifact
        if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
        uses: actions/upload-pages-artifact@v3  # Updated to v3
        with:
          path: ./public

  deploy:
    if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4  # Updated to v4

  cleanup:
    if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: [build, deploy]
    permissions:
      actions: write
      contents: write
    env:
      CLEANUP_WORKFLOW_RUNS: 'true'
      CLEANUP_GIT_HISTORY: 'true'
      KEEP_RUNS_COUNT: '10'
      KEEP_COMMITS_COUNT: '10'
      GIT_CLEANUP_STRATEGY: 'preserve'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: éªŒè¯åˆ†æ”¯å’ŒçŽ¯å¢ƒ
        run: |
          echo "::group::çŽ¯å¢ƒæ£€æŸ¥"
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref }}"
          echo "äº‹ä»¶ç±»åž‹: ${{ github.event_name }}"
          
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::æ¸…ç†åŠŸèƒ½ä»…åœ¨ main åˆ†æ”¯æ‰§è¡Œ"
            exit 1
          fi
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "::error::æ¸…ç†åŠŸèƒ½ä¸åœ¨ Pull Request ä¸­æ‰§è¡Œ"
            exit 1
          fi
          
          echo "âœ“ çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡"
          echo "::endgroup::"

      - name: éªŒè¯æƒé™
        run: |
          echo "::group::æƒé™æ£€æŸ¥"
          
          if [ -z "${{ github.token }}" ]; then
            echo "::error::GITHUB_TOKEN æœªè®¾ç½®"
            exit 1
          fi
          
          echo "âœ“ GITHUB_TOKEN å·²é…ç½®"
          
          # æ£€æŸ¥ token æƒé™ï¼ˆé€šè¿‡å°è¯•è®¿é—® APIï¼‰
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=1")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ“ Actions API è®¿é—®æƒé™æ­£å¸¸"
          else
            echo "::warning::Actions API è®¿é—®è¿”å›žçŠ¶æ€ç : $RESPONSE"
            echo "å¯èƒ½ç¼ºå°‘ actions:write æƒé™ï¼Œworkflow runs æ¸…ç†å¯èƒ½å¤±è´¥"
          fi
          
          echo "::endgroup::"

      - name: èŽ·å–æ¸…ç†å‰çš„ Workflow Runs ç»Ÿè®¡
        if: env.CLEANUP_WORKFLOW_RUNS == 'true'
        id: runs-before
        run: |
          echo "::group::æ¸…ç†å‰ç»Ÿè®¡"
          RUNS_COUNT=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq '.total_count')
          echo "å½“å‰ Workflow Runs æ€»æ•°: $RUNS_COUNT"
          echo "runs_count=$RUNS_COUNT" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: æ¸…ç†æ—§çš„ Workflow Runs
        if: env.CLEANUP_WORKFLOW_RUNS == 'true'
        id: cleanup-runs
        continue-on-error: true
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: ${{ env.KEEP_RUNS_COUNT }}

      - name: èŽ·å–æ¸…ç†åŽçš„ Workflow Runs ç»Ÿè®¡
        if: env.CLEANUP_WORKFLOW_RUNS == 'true'
        run: |
          echo "::group::æ¸…ç†åŽç»Ÿè®¡"
          RUNS_COUNT=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq '.total_count')
          echo "æ¸…ç†åŽ Workflow Runs æ€»æ•°: $RUNS_COUNT"
          DELETED=$(($${{ steps.runs-before.outputs.runs_count }} - $RUNS_COUNT))
          echo "å·²åˆ é™¤ Workflow Runs æ•°é‡: $DELETED"
          echo "::endgroup::"

      - name: æ£€æŸ¥æ¸…ç†ç»“æžœ
        if: env.CLEANUP_WORKFLOW_RUNS == 'true' && steps.cleanup-runs.outcome == 'failure'
        run: |
          echo "::warning::Workflow Runs æ¸…ç†å¤±è´¥ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹"
          echo "::error::æ¸…ç†é”™è¯¯è¯¦æƒ…: ${{ steps.cleanup-runs.outputs.error }}"
          echo "è¯·æ£€æŸ¥æƒé™é…ç½®æˆ–æ‰‹åŠ¨æ¸…ç†"

      - name: å±é™©æ“ä½œè­¦å‘Š
        if: env.CLEANUP_GIT_HISTORY == 'true'
        run: |
          echo "::warning::âš ï¸  Git åŽ†å²åŽ‹ç¼©å·²å¯ç”¨ - è¿™æ˜¯ä¸€ä¸ªå±é™©æ“ä½œï¼"
          echo "::warning::æ­¤æ“ä½œå°†ï¼š"
          echo "::warning::  - é‡å†™ Git åŽ†å²"
          echo "::warning::  - ä½¿æ‰€æœ‰åä½œè€…éœ€è¦é‡æ–°å…‹éš†ä»“åº“"
          echo "::warning::  - ä½¿çŽ°æœ‰ Pull Requests å¤±æ•ˆ"
          echo "::warning::  - å¯èƒ½ä¸¢å¤±åŽ†å²è¿½æº¯ä¿¡æ¯"
          echo ""
          echo "å¤‡ä»½æ ‡ç­¾å°†è¢«åˆ›å»ºä»¥ä¾¿ç´§æ€¥æ¢å¤"

      - name: åŠ è½½ Git æ¸…ç†é…ç½®
        if: env.CLEANUP_GIT_HISTORY == 'true'
        run: |
          chmod +x .github/scripts/cleanup-config.sh
          .github/scripts/cleanup-config.sh

      - name: åˆ›å»ºå¤‡ä»½æ ‡ç­¾
        if: env.CLEANUP_GIT_HISTORY == 'true'
        id: backup
        continue-on-error: true
        run: |
          chmod +x .github/scripts/create-backup.sh
          .github/scripts/create-backup.sh

      - name: åŽ‹ç¼© Git åŽ†å² (ä¿ç•™ç­–ç•¥)
        if: env.CLEANUP_GIT_HISTORY == 'true' && env.GIT_CLEANUP_STRATEGY == 'preserve'
        id: compress-preserve
        continue-on-error: true
        run: |
          chmod +x .github/scripts/compress-preserve.sh
          .github/scripts/compress-preserve.sh

      - name: åŽ‹ç¼© Git åŽ†å² (å®Œå…¨åŽ‹ç¼©ç­–ç•¥)
        if: env.CLEANUP_GIT_HISTORY == 'true' && env.GIT_CLEANUP_STRATEGY == 'squash'
        id: compress-squash
        continue-on-error: true
        run: |
          chmod +x .github/scripts/compress-squash.sh
          .github/scripts/compress-squash.sh

      - name: Force Push åˆ°è¿œç¨‹
        if: env.CLEANUP_GIT_HISTORY == 'true' && (steps.compress-preserve.outcome == 'success' || steps.compress-squash.outcome == 'success')
        id: force-push
        continue-on-error: true
        run: |
          chmod +x .github/scripts/force-push.sh
          .github/scripts/force-push.sh

      - name: éªŒè¯åŽ‹ç¼©ç»“æžœ
        if: env.CLEANUP_GIT_HISTORY == 'true' && steps.force-push.outcome == 'success'
        run: |
          echo "::group::åŽ‹ç¼©ç»“æžœéªŒè¯"
          COMMITS_AFTER=$(git rev-list --count HEAD)
          echo "åŽ‹ç¼©åŽæäº¤æ•°: $COMMITS_AFTER"
          
          if [ "$GIT_CLEANUP_STRATEGY" = "squash" ]; then
            if [ "$COMMITS_AFTER" -eq 1 ]; then
              echo "âœ“ å®Œå…¨åŽ‹ç¼©æˆåŠŸï¼ŒåŽ†å²å·²åŽ‹ç¼©ä¸ºå•ä¸ªæäº¤"
            else
              echo "::warning::å®Œå…¨åŽ‹ç¼©åŽæäº¤æ•°ä¸ä¸º 1ï¼Œå®žé™…ä¸º $COMMITS_AFTER"
            fi
          else
            if [ "$COMMITS_AFTER" -le "$KEEP_COMMITS_COUNT" ]; then
              echo "âœ“ ä¿ç•™ç­–ç•¥åŽ‹ç¼©æˆåŠŸï¼Œä¿ç•™äº† $COMMITS_AFTER æ¬¡æäº¤"
            else
              echo "::warning::ä¿ç•™çš„æäº¤æ•° ($COMMITS_AFTER) è¶…è¿‡é¢„æœŸ ($KEEP_COMMITS_COUNT)"
            fi
          fi
          
          echo "å¤‡ä»½æ ‡ç­¾: ${{ steps.backup.outputs.backup_tag }}"
          echo "æ–°çš„ HEAD SHA: ${{ steps.force-push.outputs.pushed_sha }}"
          echo "::endgroup::"

      - name: è‡ªåŠ¨å›žæ»š
        if: env.CLEANUP_GIT_HISTORY == 'true' && steps.force-push.outcome == 'failure' && steps.backup.outcome == 'success'
        run: |
          echo "::warning::æ£€æµ‹åˆ° force push å¤±è´¥ï¼Œå°è¯•è‡ªåŠ¨å›žæ»š..."
          chmod +x .github/scripts/rollback.sh
          if .github/scripts/rollback.sh "${{ steps.backup.outputs.backup_tag }}"; then
            echo "âœ“ è‡ªåŠ¨å›žæ»šæˆåŠŸ"
          else
            echo "::error::è‡ªåŠ¨å›žæ»šå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨æ¢å¤"
          fi

      - name: æ£€æŸ¥ Git åŽ‹ç¼©é”™è¯¯
        if: env.CLEANUP_GIT_HISTORY == 'true' && (steps.compress-preserve.outcome == 'failure' || steps.compress-squash.outcome == 'failure' || steps.force-push.outcome == 'failure')
        run: |
          echo "::error::Git åŽ†å²åŽ‹ç¼©å¤±è´¥"
          echo "å¤‡ä»½æ ‡ç­¾: ${{ steps.backup.outputs.backup_tag }}"
          echo ""
          echo "æ‰‹åŠ¨æ¢å¤å‘½ä»¤:"
          echo "  git fetch origin"
          echo "  git reset --hard ${{ steps.backup.outputs.backup_tag }}"
          echo "  git push -f origin main"

      - name: ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
        if: always()
        run: |
          echo "# æ¸…ç†ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æ‰§è¡Œæ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "- å¼€å§‹æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Workflow Runs æ¸…ç†" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.CLEANUP_WORKFLOW_RUNS }}" = "true" ]; then
            if [ "${{ steps.cleanup-runs.outcome }}" = "success" ]; then
              echo "âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              echo "- æ¸…ç†å‰: ${{ steps.runs-before.outputs.runs_count }} æ¬¡è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
              echo "- ä¿ç•™æ•°é‡: ${{ env.KEEP_RUNS_COUNT }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ å·²è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Git åŽ†å²åŽ‹ç¼©" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.CLEANUP_GIT_HISTORY }}" = "true" ]; then
            if [ "${{ steps.force-push.outcome }}" = "success" ]; then
              echo "âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              echo "- ç­–ç•¥: ${{ env.GIT_CLEANUP_STRATEGY }}" >> $GITHUB_STEP_SUMMARY
              echo "- å¤‡ä»½æ ‡ç­¾: \`${{ steps.backup.outputs.backup_tag }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- æ–°çš„ HEAD: \`${{ steps.force-push.outputs.pushed_sha }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              if [ -n "${{ steps.backup.outputs.backup_tag }}" ]; then
                echo "- å¤‡ä»½æ ‡ç­¾: \`${{ steps.backup.outputs.backup_tag }}\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "â­ï¸ å·²è·³è¿‡ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ä»¥èŽ·å–æ›´å¤šä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
